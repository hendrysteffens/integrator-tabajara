/*
 * This Kotlin source file was generated by the Gradle 'init' task.
 */
package integrator.generator

import integrator.generator.generator.generateDto
import integrator.generator.generator.generateWorkflow
import integrator.generator.sdl.ExtractSdlData
import integrator.generator.tbs.TbsDataExtractor
import integrator.generator.template.DtoTemplate
import integrator.generator.template.WorkflowTemplate
import integrator.generator.util.FileGenerator
import java.io.File
import java.io.FileInputStream
import java.nio.file.Paths
import java.util.*

class App {
    companion object {
        private var loaded = false
        private val _props = Properties()
        val props: Properties
            get() {
                if (!loaded) {
                    _props.load(FileInputStream(this.javaClass.classLoader.getResource("generator.properties").file))
                    loaded = true
                }
                return _props
            }

        val entity: String
            get() {
                return ExtractSdlData(props).getSdlEntityText();
            }
    }
}

fun main(args: Array<String>) {

    if (args.isNotEmpty()) {
        App.props.setProperty("integrator.entity", args[0])
    }

    if (File("main.sdl").exists()) {
        App.props.setProperty("integrator.backend.location", Paths.get("").toAbsolutePath().toString())
    }

    ExtractSdlData(App.props).extractData(App.entity).second.forEach {
        fields -> println(fields)
    }
    println(generateDto(ExtractSdlData(App.props).extractData(App.entity), DtoTemplate().templateString));

    TbsDataExtractor(App.props).extractTbsData()?.let{
        FileGenerator().createFileByNameAndText(App.props.getProperty("integrator.entity"), ExtractSdlData(App.props).extractData(App.entity).first+"Workflow.java",generateWorkflow(it, ExtractSdlData(App.props).extractData(App.entity).first.toString(), WorkflowTemplate().templateString, ExtractSdlData(App.props).extractData(App.entity).second))
    };

    FileGenerator().createFileByNameAndText(App.props.getProperty("integrator.entity"), ExtractSdlData(App.props).extractData(App.entity).first+"Dto.java", generateDto(ExtractSdlData(App.props).extractData(App.entity), DtoTemplate().templateString))

}

